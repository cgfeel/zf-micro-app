# `wujie` ä¸­ `patchCssRules` å­˜åœ¨é‡å¤åŠ è½½çš„ `Bug`

`patchCssRules` è¯´æ˜è§ï¼šæ€»ç»“ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#-patchcssrules-%E5%AD%90%E5%BA%94%E7%94%A8%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]

é—®é¢˜æè¿°ï¼š

- `umd` æ¨¡å¼ä¸‹ `patchCssRules` å­˜åœ¨é‡å¤æ·»åŠ æ ·å¼çš„æƒ…å†µ

ä»¥å­åº”ç”¨ `react-project` ä¸¾ä¾‹ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra)]ï¼š

- æ€»å…±åŒ…å« 2 ä¸ªæ ·å¼ï¼š`index.css`ã€`App.css` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/tree/main/src)]
- åœ¨ `index.css` ä¸­æ·»åŠ  `:root` å’Œ `@font-face` å…±è®¡ 2 ä¸ª [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/src/index.css)]

## åˆæ¬¡åŠ è½½åº”ç”¨æ˜¯æ­£å¸¸çš„

æµç¨‹é¡ºåºä»ä¸Šåˆ°ä¸‹ï¼Œæ ‡ ğŸŒŸ è¯´æ˜æ’å…¥ `style` å…ƒç´ åˆ° `Dom` ä¸­ï¼Œè¡¨ ğŸ“ è¯´æ˜ `style` å…ƒç´ è®°å½•åˆ°å®ä¾‹ä¸­ï¼š

### 1. æ³¨å…¥èµ„æºï¼š

| åŠ è½½æ–¹å¼                                                                                                                                                                                      | è°ƒç”¨åœºæ™¯                                                                                                                                                               | åŠ è½½æ ·å¼               | è¯´æ˜                                                         |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ------------------------------------------------------------ |
| `renderTemplateToShadowRoot` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#rendertemplatetoshadowroot-%E6%B8%B2%E6%9F%93%E8%B5%84%E6%BA%90%E5%88%B0-shadowroot)] | `active`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L232)]                    | ğŸŒŸ `WUJIE_SHADE_STYLE` | é™æ€æ ·å¼ï¼Œå°†ä½œä¸ºå®¹å™¨ `html` å…ƒç´ ä¸‹çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç”¨äºæ’‘å¼€åº”ç”¨ |
| `patchRenderEffect` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#patchrendereffect-%E4%B8%BA%E5%AE%B9%E5%99%A8%E6%89%93%E8%A1%A5%E4%B8%81)]                     | `renderTemplateToShadowRoot`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L235)] | æ²¡æœ‰                   | ä¸åŠ è½½æ ·å¼ï¼Œåªé‡å†™ `Dom` å†™å…¥æ“ä½œï¼Œä¸ºåŠ¨æ€åŠ è½½æ ·å¼åšå‡†å¤‡      |
| `patchCssRules` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#-patchcssrules-%E5%AD%90%E5%BA%94%E7%94%A8%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]          | `active`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L233)]                    | æ²¡æœ‰                   | é™æ€æ ·å¼ä¸­æ²¡æœ‰åŒ¹é…åˆ°ï¼Œç­‰å¾… `script` æ³¨å…¥ååŠ¨æ€æ¸²æŸ“æ ·å¼       |
| `insertScriptToIframe` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#insertscripttoiframe%E4%B8%BA%E6%B2%99%E7%AE%B1%E6%8F%92%E5%85%A5-script)]                  | `start`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L286)]                     | æ²¡æœ‰                   | æ³¨å…¥ `script` æ¸²æŸ“åº”ç”¨                                       |

### 2. åŠ¨æ€åŠ è½½ `index.css`ï¼š

| åŠ è½½æ–¹å¼                                                                                                                                                                                                                                    | è°ƒç”¨åœºæ™¯                                                                                                                                                               | åŠ è½½æ ·å¼             | è¯´æ˜                                                                           |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------- | ------------------------------------------------------------------------------ |
| `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L158)]                                                                      | `patchRenderEffect`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L427)]          | æ²¡æœ‰                 | åŠ«æŒ `Dom` å†™å…¥                                                                |
| `styles` - `styleSheetElements` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#2-stylesheetelements-%E6%94%B6%E9%9B%86%E6%A0%B7%E5%BC%8F%E8%A1%A8)]                                                             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L247)] | æ²¡æœ‰                 | ğŸ“ æ”¶é›† `style` å…ƒç´ åšè®°å½•                                                     |
| `styles` - `rawDOMAppendOrInsertBefore`                                                                                                                                                                                                     | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L251)] | ğŸŒŸ ç©ºçš„ `style` å…ƒç´  | æ¥è‡ª `React` åº”ç”¨æ·»åŠ                                                           |
| `patchStylesheetElement` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#patchstylesheetelement%E5%8A%AB%E6%8C%81%E5%A4%84%E7%90%86%E6%A0%B7%E5%BC%8F%E5%85%83%E7%B4%A0%E7%9A%84%E5%B1%9E%E6%80%A7)]             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L253)] | æ²¡æœ‰                 | åŠ«æŒ `style` å†™å…¥æ“ä½œ                                                          |
| `handleStylesheetElementPatch` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)] | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L254)] | æ²¡æœ‰                 | `style` å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡ä¸å¤„ç†                                                   |
| `appendChild`                                                                                                                                                                                                                               | `patchStylesheetElement`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L139)]     | `index.css`          | å°†æ ·å¼å†…å®¹æ³¨å…¥ `style` å…ƒç´ ï¼Œæ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œ `handleStylesheetElementPatch` |

### 3. åŠ¨æ€åŠ è½½ `App.css`ï¼š

| åŠ è½½æ–¹å¼                                                                                                                                                                                                                                    | è°ƒç”¨åœºæ™¯                                                                                                                                                               | åŠ è½½æ ·å¼             | è¯´æ˜                                                                           |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------- | ------------------------------------------------------------------------------ |
| `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L158)]                                                                      | `patchRenderEffect`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L427)]          | æ²¡æœ‰                 | åŠ«æŒ `Dom` å†™å…¥                                                                |
| `styles` - `styleSheetElements` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#2-stylesheetelements-%E6%94%B6%E9%9B%86%E6%A0%B7%E5%BC%8F%E8%A1%A8)]                                                             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L247)] | æ²¡æœ‰                 | ğŸ“ æ”¶é›† `style` å…ƒç´ åšè®°å½•                                                     |
| `styles` - `rawDOMAppendOrInsertBefore`                                                                                                                                                                                                     | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L251)] | ğŸŒŸ ç©ºçš„ `style` å…ƒç´  | æ¥è‡ª `React` åº”ç”¨æ·»åŠ                                                           |
| `patchStylesheetElement` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#patchstylesheetelement%E5%8A%AB%E6%8C%81%E5%A4%84%E7%90%86%E6%A0%B7%E5%BC%8F%E5%85%83%E7%B4%A0%E7%9A%84%E5%B1%9E%E6%80%A7)]             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L253)] | æ²¡æœ‰                 | åŠ«æŒ `style` å†™å…¥æ“ä½œ                                                          |
| `handleStylesheetElementPatch` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)] | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L254)] | æ²¡æœ‰                 | `style` å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡ä¸å¤„ç†                                                   |
| `appendChild`                                                                                                                                                                                                                               | `patchStylesheetElement`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L139)]     | `App.css`            | å°†æ ·å¼å†…å®¹æ³¨å…¥ `style` å…ƒç´ ï¼Œæ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œ `handleStylesheetElementPatch` |

### 4. æå–æ ·å¼æ‰“è¡¥ä¸ï¼š

| åŠ è½½æ–¹å¼                                                                                                                                                                                                                                    | è°ƒç”¨åœºæ™¯                                                                                                                                                                | åŠ è½½æ ·å¼                        | è¯´æ˜                                                                                                         |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| `handleStylesheetElementPatch` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)] | `appendChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L141)]                 | æ²¡æœ‰                            | `index.css` æ‰“è¡¥ä¸ï¼Œå‘èµ·å®ä»»åŠ¡ `patcher`                                                                     |
| `handleStylesheetElementPatch` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)] | `appendChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L141)]                 | æ²¡æœ‰                            | `App.css` æ‰“è¡¥ä¸ï¼Œå‘èµ·å®ä»»åŠ¡ `patcher`                                                                       |
| `patcher` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]                      | `handleStylesheetElementPatch`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L66)] | `:host`                         | ä» `index.css` ä¸­æå– `:host`ï¼Œé€šè¿‡ `appendChild` æ’å…¥å®¹å™¨ `head`ï¼Œç”±äºæ–¹æ³•è¢«é‡å†™æ‰€ä»¥å†™å…¥ `:host` å°†å†è¢«æ‹¦æˆª |
| `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L158)]                                                                      | `patchRenderEffect`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L427)]           | æ²¡æœ‰                            | åŠ«æŒ `Dom` å†™å…¥                                                                                              |
| `styles` - `styleSheetElements` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#2-stylesheetelements-%E6%94%B6%E9%9B%86%E6%A0%B7%E5%BC%8F%E8%A1%A8)]                                                             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L247)]  | æ²¡æœ‰                            | ğŸ“ æ”¶é›† `style` å…ƒç´ åšè®°å½•                                                                                   |
| `styles` - `rawDOMAppendOrInsertBefore`                                                                                                                                                                                                     | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L251)]  | ğŸŒŸ å°†æå–çš„ `:host` æ’å…¥ `head` | æ¥è‡ªå®ä»»åŠ¡ `patcher` å°† `:host` æ’å…¥ `head`                                                                  |
| `patchStylesheetElement` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#patchstylesheetelement%E5%8A%AB%E6%8C%81%E5%A4%84%E7%90%86%E6%A0%B7%E5%BC%8F%E5%85%83%E7%B4%A0%E7%9A%84%E5%B1%9E%E6%80%A7)]             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L253)]  | æ²¡æœ‰                            | æ‹¦æˆª `style` å±æ€§ï¼Œä½† `:host` æ— éœ€å†æ“ä½œ                                                                     |
| `handleStylesheetElementPatch` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)] | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L254)]  | æ²¡æœ‰                            | `:host` æ‰“è¡¥ä¸ï¼Œå‘èµ·å®ä»»åŠ¡ `patcher`                                                                         |
| `patcher` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]                      | `handleStylesheetElementPatch`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L66)] | ğŸŒŸ `@font-face`                 | ä» `index.css` ä¸­æå– `@font-face` æ’å…¥ `shadowRoot.host`                                                    |
| `patcher` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]                      | `handleStylesheetElementPatch`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L66)] | æ²¡æœ‰                            | `App.css` ä¸­æ²¡æœ‰æå–åˆ°æ ·å¼éœ€è¦æ‰“è¡¥ä¸                                                                         |
| `patcher` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]                      | `handleStylesheetElementPatch`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L66)] | æ²¡æœ‰                            | `:host` ä¸­æ²¡æœ‰æå–åˆ°æ ·å¼éœ€è¦æ‰“è¡¥ä¸                                                                           |

åŠ¨æ€åŠ è½½çš„æ ·å¼å…±æœ‰ 6 å¤„ï¼š

- `shadowRoot.host` æœ«å°¾ 1 å¤„ï¼š`@font-face`
- å®¹å™¨ `html` ä¸‹ç¬¬ 1 ä¸ªå­å…ƒç´ ï¼š`WUJIE_SHADE_STYLE`
- å®¹å™¨ `head` ä¸‹æœ‰ 3 å¤„ï¼š`index.css`ã€`App.css`ã€`:host`

`styleSheetElements` é›†åˆå…±æœ‰ 3 é¡¹ï¼š

- `index.css`ã€`App.css`ã€`:host`

## åˆ‡æ¢åº”ç”¨å­˜åœ¨é‡å¤å¼•å…¥æ ·å¼çš„é—®é¢˜

æµç¨‹é¡ºåºä»ä¸Šåˆ°ä¸‹ï¼Œæ ‡ ğŸŒŸ è¯´æ˜æ’å…¥ `style` å…ƒç´ åˆ° `Dom` ä¸­ï¼Œè¡¨ ğŸ“ è¯´æ˜ `style` å…ƒç´ è®°å½•åˆ°å®ä¾‹ä¸­ï¼š

### 1. æ³¨å…¥èµ„æºï¼š

| åŠ è½½æ–¹å¼                                                                                                                                                                                      | è°ƒç”¨åœºæ™¯                                                                                                                                                               | åŠ è½½æ ·å¼               | è¯´æ˜                                                         |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ------------------------------------------------------------ |
| `renderTemplateToShadowRoot` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#rendertemplatetoshadowroot-%E6%B8%B2%E6%9F%93%E8%B5%84%E6%BA%90%E5%88%B0-shadowroot)] | `active`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L232)]                    | ğŸŒŸ `WUJIE_SHADE_STYLE` | é™æ€æ ·å¼ï¼Œå°†ä½œä¸ºå®¹å™¨ `html` å…ƒç´ ä¸‹çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç”¨äºæ’‘å¼€åº”ç”¨ |
| `patchRenderEffect` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#patchrendereffect-%E4%B8%BA%E5%AE%B9%E5%99%A8%E6%89%93%E8%A1%A5%E4%B8%81)]                     | `renderTemplateToShadowRoot`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L235)] | æ²¡æœ‰                   | ä¸åŠ è½½æ ·å¼ï¼Œåªé‡å†™ `Dom` å†™å…¥æ“ä½œï¼Œä¸ºåŠ¨æ€åŠ è½½æ ·å¼åšå‡†å¤‡      |
| `patchCssRules` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#-patchcssrules-%E5%AD%90%E5%BA%94%E7%94%A8%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]          | `active`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L233)]                    | æ²¡æœ‰                   | é™æ€æ ·å¼ä¸­æ²¡æœ‰åŒ¹é…åˆ°ï¼Œç­‰å¾… `script` æ³¨å…¥ååŠ¨æ€æ¸²æŸ“æ ·å¼       |

### 2. é‡å»ºæ ·å¼ï¼š

| åŠ è½½æ–¹å¼                                                                                                                                                                                                                                    | è°ƒç”¨åœºæ™¯                                                                                                                                                                                       | åŠ è½½æ ·å¼                           | è¯´æ˜                                                                                |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------- | ----------------------------------------------------------------------------------- |
| `rebuildStyleSheets` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#-rebuildstylesheets-%E9%87%8D%E6%96%B0%E6%81%A2%E5%A4%8D%E6%A0%B7%E5%BC%8F)]                                                                | `startApp`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L245)]                                            | ğŸŒŸ `index.css`ã€`App.css`ã€`:host` | é€šè¿‡ `styleSheetElements` æ¢å¤æ ·å¼                                                  |
| `patchCssRules` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#-patchcssrules-%E5%AD%90%E5%BA%94%E7%94%A8%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)]                                                        | `rebuildStyleSheets`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L446)]                                | æ²¡æœ‰                               | å†æ¬¡æå–åˆ° `:host` æ‰§è¡Œ `appendChild`ï¼Œç”±äºæ³¨å…¥èµ„æºæ—¶å·²é‡å†™äº†æ–¹æ³•ï¼Œæ‰€ä»¥æ“ä½œä¼šè¢«æ‹¦æˆª |
| `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L158)]                                                                      | `patchRenderEffect`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L427)]                                  | æ²¡æœ‰                               | åŠ«æŒ `Dom` å†™å…¥                                                                     |
| `styles` - `styleSheetElements` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#2-stylesheetelements-%E6%94%B6%E9%9B%86%E6%A0%B7%E5%BC%8F%E8%A1%A8)]                                                             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L247)]                         | æ²¡æœ‰                               | ğŸ“ æ”¶é›† `:host` æ ·å¼å…ƒç´ åšè®°å½•                                                      |
| `styles` - `rawDOMAppendOrInsertBefore`                                                                                                                                                                                                     | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L251)]                         | ğŸŒŸ å°†æå–çš„ `:host` æ’å…¥ `head`    | ç”± `patchCssRules` é‡å¤æ‰§è¡Œå¯¼è‡´                                                     |
| `patchStylesheetElement` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#patchstylesheetelement%E5%8A%AB%E6%8C%81%E5%A4%84%E7%90%86%E6%A0%B7%E5%BC%8F%E5%85%83%E7%B4%A0%E7%9A%84%E5%B1%9E%E6%80%A7)]             | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L253)]                         | æ²¡æœ‰                               | æ‹¦æˆª `style` å±æ€§ï¼Œä½† `:host` æ— éœ€å†æ“ä½œ                                            |
| `handleStylesheetElementPatch` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#handlestylesheetelementpatch%E4%B8%BA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%8A%A8%E6%80%81%E6%A0%B7%E5%BC%8F%E6%89%93%E8%A1%A5%E4%B8%81)] | `rewriteAppendOrInsertChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L254)]                         | æ²¡æœ‰                               | `:host` æ‰“è¡¥ä¸ï¼Œå‘èµ·å®ä»»åŠ¡ `patcher`                                                |
| `styleSheetElements` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#2-stylesheetelements-%E6%94%B6%E9%9B%86%E6%A0%B7%E5%BC%8F%E8%A1%A8)]                                                                        | æŒ‚èµ·å®ä»»åŠ¡åï¼Œç»§ç»­è¿”å›åˆ° `patchCssRules` æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L464)] | æ²¡æœ‰                               | ğŸ“ å†æ¬¡æ”¶é›† `:host` æ ·å¼å…ƒç´ åšè®°å½•                                                  |
| `fontStyleSheetElement`                                                                                                                                                                                                                     | `patchCssRules`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L467)]                                     | ğŸŒŸ `@font-face`                    | å†æ¬¡å°† `@font-face` æ·»åŠ åˆ° `shadowRoot.host` æœ«å°¾                                   |
